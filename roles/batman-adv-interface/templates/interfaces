# {{ ansible_managed }}

auto {{ batman_dummy_interface }}
iface {{ batman_dummy_interface }} inet manual
	pre-up ip link add name $IFACE type dummy
	up ip link set $IFACE up
	down ip link set $IFACE down
	post-down ip link del $IFACE

auto {{ batman_interface }}
iface {{ batman_interface }} inet manual
	batadv-ports {{ batman_dummy_interface }}
	batadv-hw {{ ansible_default_ipv4.macaddress | derive_mac_addr(2) }}
	batadv-hop-penalty {{ batman_hop_penalty }}
{% if batman_gateway %}
	batadv-gw-mode server
	batadv-gw-bandwidth 100Mbit/100Mbit
{% endif %}
	# set interface up
	up ip link set $IFACE up
	down ip link set $IFACE down

auto br-{{ site_code }}
iface br-{{ site_code }} inet static
	bridge-ports {{ batman_interface }}
	bridge-maxwait 0
	address {{ batman_ipv4.address }}
	netmask {{ batman_ipv4.netmask }}
{% if batman_table != "default" %}
	# unreachable route in {{ batman_table }}
	# prevents leak of data
	post-up  ip -4 route add unreachable default metric 2048 table {{ batman_table }}
	pre-down ip -4 route del unreachable default metric 2048 table {{ batman_table }}
	post-up  ip -6 route add unreachable default metric 2048 table {{ batman_table }}
	pre-down ip -6 route del unreachable default metric 2048 table {{ batman_table }}
	# rules to send stuff to VPN
	post-up  ip -4 rule add iif $IFACE table {{ batman_table }} priority 16385
	pre-down ip -4 rule del iif $IFACE table {{ batman_table }} priority 16385
	post-up  ip -6 rule add iif $IFACE table {{ batman_table }} priority 32767
	pre-down ip -6 rule del iif $IFACE table {{ batman_table }} priority 32767
	# duplicate main table (IPv4 only)
	post-up  ip -4 rule add priority 16384 lookup main
	pre-down ip -4 rule del priority 16384 lookup main
	# rules to lookup default route (IPv6 only)
	post-up  ip -6 rule add table default priority 32769
	pre-down ip -6 rule del table default priority 32769
{% endif %}

iface br-{{ site_code }} inet6 static
	address {{ batman_ipv6_local.address }}/64
	netmask 64
{% if batman_ipv6_global %}
	up   ip -6 addr add {{ batman_ipv6_global.address }}/64 dev $IFACE
	down ip -6 addr del {{ batman_ipv6_global.address }}/64 dev $IFACE
{% endif %}
