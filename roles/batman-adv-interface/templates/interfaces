# {{ ansible_managed }}

auto {{ batman_interface_name }}_dummy
iface {{ batman_interface_name }}_dummy inet manual
	pre-up ip link add name $IFACE type dummy
	up ip link set $IFACE up
	down ip link set $IFACE down
	post-down ip link del $IFACE

auto {{ batman_interface_name }}
iface {{ batman_interface_name }} inet manual
	batadv-ports {{ batman_interface_name }}_dummy
	batadv-hw {{ ansible_default_ipv4.macaddress | derive_mac_addr(2) }}
	batadv-hop-penalty {{ batman_hop_penalty }}
{% if batman_gateway %}
	batadv-gw-mode server
	batadv-gw-bandwidth 100Mbit/100Mbit
{% endif %}
	# set interface up
	up ip link set $IFACE up
	down ip link set $IFACE down

auto br-{{ site_code }}
iface br-{{ site_code }} inet static
	bridge-ports {{ batman_interface_name }}
	bridge-maxwait 0
	address {{ batman_ipv4_address }}
	netmask {{ batman_ipv4_netmask }}
{% if batman_gateway %}
	# unreachable route in freifunk-default
	# prevents leak of data
	post-up ip route add unreachable default metric 2048 table default-freifunk
	pre-down ip route del unreachable default metric 2048 table default-freifunk
	post-up ip -6 route add unreachable default metric 2048 table default-freifunk
	pre-down ip -6 route del unreachable default metric 2048 table default-freifunk
	# rules to send stuff to VPN
	post-up ip rule add iif $IFACE table default-freifunk priority 16385
	pre-down ip rule del iif $IFACE table default-freifunk priority 16385
	post-up ip -6 rule add iif $IFACE table default-freifunk priority 32767
	pre-down ip -6 rule del iif $IFACE table default-freifunk priority 32767
{% endif %}

iface br-{{ site_code }} inet6 static
	address {{ batman_ipv6_address }}/64
	netmask 64
	up ip -6 addr add {{ batman_ipv6_address_alt }}/64 dev $IFACE
	down ip -6 addr del {{ batman_ipv6_address_alt }}/64 dev $IFACE
