---
- name: Install batctl
  apt: name=batctl

- name: Install bridge-utils
  apt: name=bridge-utils

- name: Install batman pre-up script
  copy: >
    src=if-pre-up
    dest=/etc/network/if-pre-up.d/batadv
    mode=0755

- name: Create batman routing table
  lineinfile: >
    dest=/etc/iproute2/rt_tables
    line="252 {{batman_table}}"
    regexp="^252 "
    state="{{ "absent" if batman_table == "default" else "present" }}"

- name: Install batman interfaces file
  template: >
    src=interfaces
    dest=/etc/network/interfaces.d/{{ batman_interface }}

- name: Set interfaces up
  command: ifup {{item}}
  register: ifup_result
  changed_when: '"already configured" not in ifup_result.stderr'
  with_items:
  - "{{ batman_dummy_interface }}"
  - "{{ batman_interface }}"
  - br-{{ site_code }}
