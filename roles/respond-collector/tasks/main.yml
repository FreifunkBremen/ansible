---
- name: Create users
  user: name=respond-collector generate_ssh_key=yes ssh_key_type=rsa  ssh_key_file=.ssh/id_rsa ssh_key_comment="respond-collector@{{inventory_hostname}}"

- name: Download and install go
  unarchive: src=https://storage.googleapis.com/golang/go1.7.1.linux-amd64.tar.gz  dest=/usr/local copy=no

- name: Configure go
  template: >
    src=go.sh
    dest=/etc/profile.d/go.sh

- name: Install respond-collector
  shell: >
       /usr/local/go/bin/go get -u github.com/FreifunkBremen/respond-collector
  environment:
    GOPATH: /opt/go
  notify:
    - restart respond-collector

- name: Configure respond-collector
  template: >
    src=config.yml
    dest=/etc/respond-collector.conf
  notify:
    - restart respond-collector


- name: Create directory
  file: path={{ respond_collector_nodes_path }}/ state=directory owner=respond-collector


- name: Install system unit
  template: >
    src=respond-collector.service
    dest=/lib/systemd/system/respond-collector.service
  notify:
    - reload systemd
    - restart respond-collector


- name: Enable respond-collector
  service: name=respond-collector enabled=yes

- name: Install system publish unit
  template: >
    src={{item}}
    dest=/lib/systemd/system/{{item}}
  with_items:
    - respond-collector-publish.service
    - respond-collector-publish.timer
  notify:
    - reload systemd
    - restart respond-collector-publish

- name: Enable respond-collector-publish
  service: name=respond-collector-publish.timer enabled=yes
