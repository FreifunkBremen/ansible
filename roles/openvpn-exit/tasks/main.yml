---
- name: Set up group
  group: name=openvpn system=yes

- name: Set up User
  user: name=openvpn system=yes group=openvpn createhome=no shell=/bin/false

- name: Install packages
  action: apt pkg={{ item }}
  with_items:
    - openvpn
    - iptables-persistent

- name: Install scripts and auth
  template: >
    src={{ item }}
    dest=/etc/openvpn/{{ item }}
    mode=0700
  with_items:
    - exit-up.sh
    - exit-auth
  when: openvpn_exit_hideme

- name: Install HideMe Config
  template: >
    src=exit-hide.conf
    dest=/etc/openvpn/exit.conf
    mode=0700
  when: openvpn_exit_hideme


- name: Flush iptables nat
  shell: iptables -t nat -F

- name: Install iptables nat
  shell: iptables -t nat -A POSTROUTING -s 10.196.0.0/16 -o vpn_uplink -j MASQUERADE

- name: Save iptable IPv4
  shell: iptables-save > /etc/iptables/rules.v4

- name: Restart Openvpn
  service: name=openvpn@exit state=restarted enabled=yes
