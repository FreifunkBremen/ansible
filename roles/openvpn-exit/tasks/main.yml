---
- name: Set up group
  group: name=openvpn system=yes

- name: Set up User
  user: name=openvpn system=yes group=openvpn createhome=no shell=/bin/false

- name: Install packages
  apt: name={{ item }}
  with_items:
    - openvpn
    - iptables-persistent

- name: Install configuration
  template: >
    src={{ item }}
    dest=/etc/openvpn/{{ item }}
    mode=0600
  with_items:
    - exit.conf
    - exit-auth
  when: openvpn_exit_hideme
  notify: restart openvpn

- name: Install script
  template: >
    src=exit-up.sh
    dest=/etc/openvpn/
    mode=0700
  when: openvpn_exit_hideme
  notify: restart openvpn

- name: Flush iptables nat
  shell: iptables -t nat -F

- name: Install iptables nat
  shell: iptables -t nat -A POSTROUTING -s 10.196.0.0/16 -o vpn_uplink -j MASQUERADE

- name: Save iptable IPv4
  shell: iptables-save > /etc/iptables/rules.v4
