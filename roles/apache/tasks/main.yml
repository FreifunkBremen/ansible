---
- name: Install apache2
  apt: name={{ item }}
  with_items:
    - apache2
    - apache2-suexec-pristine
    - libapache2-mod-fcgid
  notify: restart apache

- name: Start apache2
  service: name=apache2 state=started enabled=yes

- name: "Security settings: ServerTokens"
  replace: dest=/etc/apache2/conf-available/security.conf regexp='ServerTokens\s*(.*)' replace='ServerTokens Prod'
  notify: restart apache

- name: "Security settings: ServerSignature"
  replace: dest=/etc/apache2/conf-available/security.conf regexp='ServerSignature\s*(.*)' replace='ServerSignature Off'
  notify: restart apache

- name: Copy configuration files
  copy: src={{ item }} dest=/etc/apache2/conf-available/{{ item }}
  with_items:
    - anon-logs.conf
    - default-dir-options.conf
  notify: restart apache

- name: Enable configurations
  command: a2enconf {{ item }}
  with_items:
    - anon-logs.conf
    - default-dir-options.conf
  notify: restart apache

- name: Copy user included configuration files
  copy: src=user-php-exec.conf dest=/etc/apache2/user-php-exec.conf
  notify: restart apache

- name: Copy new default site configuration
  template: src=000-default.conf dest=/etc/apache2/sites-available/
  notify: restart apache

- name: Enable needed modules
  apache2_module: state=present name={{ item }}
  with_items:
    - access_compat
    - actions
    - alias
    - auth_basic
    - auth_digest
    - authn_core
    - authn_file
    - authz_core
    - authz_host
    - authz_user
    - autoindex
    - cgid
    - deflate
    - dir
    - env
    - fcgid
    - filter
    - headers
    - mime
    - mpm_event
    - negotiation
    - proxy
    - proxy_http
    - rewrite
    - setenvif
    - socache_shmcb
    - ssl
    - status
    - suexec
    - unique_id
  notify: restart apache

- name: Create directory for log files
  file: path=/readonly state=directory mode=0755
