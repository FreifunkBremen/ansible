---
- name: Add repository-gpg-key for fastd
  apt_key: keyserver={{ pgp_keyserver }} id={{ fastd_repository_key }}

- name: Add apt repository
  apt_repository: repo='deb {{ fastd_repository_url }}'

- name: Install fastd
  apt: name=fastd

- name: Create peers directory
  file: path={{ fastd_peers_directory }} state=directory

- name: Create peer configurations
  template: src=peer.conf dest={{ fastd_peers_directory }}/{{item.key}}.conf
  with_dict: "{{site.fastd_mesh_vpn.groups.backbone.peers}}"
  notify:
  - restart fastd

- name: List peers
  shell: ls -1 {{ fastd_peers_directory }}
  register: contents

- name: Delete unused peers
  file: path={{ fastd_peers_directory }}/{{ item }} state=absent
  with_items: contents.stdout_lines
  when: item.replace(".conf","") not in site.fastd_mesh_vpn.groups.backbone.peers
  notify:
  - restart fastd

- name: Generate fastd secret
  fastd_key: /etc/fastd/{{ site_code }}/secret.conf
  notify:
  - restart fastd

- name: Generate dynamic configration part
  template: >
    src=fastd.conf
    dest=/etc/fastd/{{ site_code }}/fastd.conf
    mode=0644
  notify:
  - restart fastd

- name: Add network configuration
  template: src=interfaces dest=/etc/network/interfaces.d/{{ fastd_interface_name }}

- name: Install fastd blacklist
  include: blacklist.yml
