---
- name: Add repository-gpg-key for fastd
  apt_key: keyserver={{ pgp_keyserver }} id={{ fastd_repository_key }}

- name: Add apt repository
  apt_repository: repo='deb {{ fastd_repository_url }}'

- name: Install fastd
  apt: name=fastd

- name: Load site configuration
  local_action: parse_lua url={{site_conf_url}} var=site_conf

- name: Copy static fastd configuration files
  template: src=peer.conf dest=/etc/fastd/{{ site_code }}/peers/{{item.key}}.conf
  with_dict: "{{site_conf.fastd_mesh_vpn.groups.backbone.peers}}"
  notify:
  - restart fastd

- name: Generate fastd secret
  fastd_key: /etc/fastd/{{ site_code }}/secret.conf
  notify:
  - restart fastd

- name: Generate dynamic configration part
  template: >
    src=fastd.conf
    dest=/etc/fastd/{{ site_code }}/fastd.conf
    mode=0644
  notify:
  - restart fastd

- name: Add network configuration
  template: src=interfaces dest=/etc/network/interfaces.d/{{ fastd_interface_name }}

- name: Install fastd blacklist
  include: blacklist.yml
