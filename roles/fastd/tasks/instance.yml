---
- name: Create fastd directory
  file: path=/etc/fastd/{{ fastd_instance }} state=directory

- name: Upload fastd.conf
  template: src=fastd.conf dest=/etc/fastd/{{ fastd_instance }}/
  notify:
  - restart fastd

- name: Add network configuration
  template: src=interfaces dest=/etc/network/interfaces.d/{{ fastd_interface }}

- name: Create peers directory
  file: path=/etc/fastd/{{ fastd_instance }}/peers state=directory

- name: Create peer configurations
  template: src=peer.conf dest=/etc/fastd/{{ fastd_instance }}/peers/{{item.key}}.conf
  with_dict: "{{fastd.peers}}"
  notify:
  - restart fastd

- name: List peers
  command: ls -1 /etc/fastd/{{ fastd_instance }}/peers
  changed_when: False
  register: contents

- name: Delete unused peers
  file: path=/etc/fastd/{{ fastd_instance }}/peers/{{ item }} state=absent
  with_items: contents.stdout_lines
  when: item.replace(".conf","") not in fastd.peers
  notify:
  - restart fastd

- name: Enable fastd instance
  service: name=fastd@{{ fastd_instance }} enabled=yes
