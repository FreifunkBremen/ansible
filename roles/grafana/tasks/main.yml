---
- name: Add packagecloud key
  apt_key:
    id: 418A7F2FB0E1E6E7EABF6FE8C2E73424D59097AB
    url: https://packagecloud.io/gpg.key

- name: Add repository
  apt_repository: repo="deb https://packagecloud.io/grafana/stable/debian/ wheezy main"

- name: Install grafana
  apt: name=grafana
  notify: restart grafana

- name: Configurate grafana
  template: src=grafana.ini dest=/etc/grafana/grafana.ini
  notify: restart grafana

- name: Firewall open grafana port
  mf_add: role=grafana proto=tcp port={{ grafana_port }}

- name: Create dashboard folders
  file: path=/var/lib/grafana/dashboards state=directory mode=0750 owner=grafana group=grafana

- name: Install dashboards
  copy: src={{item}} dest=/var/lib/grafana/dashboards/{{item}} mode=0750 owner=grafana group=grafana
  with_items:
  - Short.json

- name: Enable grafana
  service: name=grafana-server state=started enabled=yes
