---
- name: Install packages
  apt:
    name:
      - nsd
      - python3

- name: Configure NSD
  template:
    src: nsd.conf
    dest: /etc/nsd/nsd.conf
    mode: 0644
    owner: root
    group: root
  notify: restart nsd

- name: Clone internal dns repo
  git:
    repo: "{{ dns_nsd_git_repo }}"
    dest: "/opt/{{ site_code }}/dns/"
    version: "{{ dns_nsd_git_commit }}"
  notify: copy zone files

- name: Install script to copy zone files
  copy:
    src: update-dns-zones.sh
    dest: /usr/local/sbin/update-dns-zones.sh
    mode: 0755
    owner: root
    group: root

- name: Copy zone files
  command: /usr/local/sbin/update-dns-zones.sh

- name: Install script to generate nodes zone
  copy:
    src: "{{ item }}"
    dest: /usr/local/bin/
    owner: root
    group: root
    mode: 0755
  with_items:
  - zonegen.py
  - zonegen-all

- name: Install timer
  import_role:
    name: timer
  vars:
    timer_name: zonegen
    timer_exec: /usr/local/bin/zonegen-all
    timer_interval: 60min

- name: Remove legacy cronjob
  file:
    path: /etc/cron.hourly/zonegen
    state: absent

- name: Initially generate nodes zone
  service: name=zonegen.service state=started

- name: Open firewall for DNS
  copy:
    src: firewall.sh
    dest: "{{ firewall_path }}/30-nsd"
    mode: 0644
    owner: root
    group: root
  when: firewall_enabled
  notify: reload firewall

- name: Autostart NSD
  service:
    name: nsd
    enabled: yes
