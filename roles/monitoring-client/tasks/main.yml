---
- name: Add user for nagios
  user:
    name: rnagios
    home: /var/lib/rnagios
    shell: /bin/bash
    system: yes

- name: Create .ssh directory
  file:
    path: /var/lib/rnagios/.ssh
    state: directory
    mode: '0700'
    owner: rnagios
    group: rnagios

- name: Copy authorized keys
  copy:
    src: authorized_keys
    dest: /var/lib/rnagios/.ssh/authorized_keys
    mode: '0600'
    owner: rnagios
    group: rnagios

- name: Install dependencies
  apt:
    name:
      - ca-certificates
      - libyaml-syck-perl
      - lsb-release
      - needrestart
      - monitoring-plugins-basic
      - monitoring-plugins-standard
      - "{{ package_prefix }}-contrib"
  vars:
    package_prefix: >-
      {{ (
          ansible_distribution == "Debian" and (ansible_distribution_version is version_compare("11", ">="))
         ) | ternary("monitoring", "nagios") }}-plugins

- name: Create directory for additional checks
  file:
    path: /usr/local/lib/nagios/plugins
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Install wrapper script
  copy:
    src: ssh-forcecommand
    dest: /usr/local/lib/nagios/ssh-forcecommand
    mode: '0755'
    owner: root
    group: root

- name: Install additional monitoring checks
  copy:
    src: "plugins/{{ item }}"
    dest: "/usr/local/lib/nagios/plugins/{{ item }}"
    mode: '0755'
    owner: root
    group: root
  loop:
    - check_git_status
    - check_release_eol
    - check_rkhunter

- name: Copy conntrack check
  copy:
    src: plugins/check_conntrack.sh
    dest: /usr/local/lib/nagios/plugins/check_conntrack.sh
    mode: '0755'
    owner: root
    group: root
  when: (('vpnservers' in group_names) or ('vpnservers_legacy' in group_names))

- name: Creates nagios configuration directory
  file:
    path: /etc/nagios
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Copy default nagios configuration file
  template:
    src: ssh-forcecommand.cfg.j2
    dest: /etc/nagios/ssh-forcecommand.cfg
    mode: '0644'
    owner: root
    group: root

- name: Create sudo config
  template:
    src: sudoers-rnagios.j2
    dest: /etc/sudoers.d/rnagios
    mode: '0440'
    owner: root
    group: root
