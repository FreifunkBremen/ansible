---
- name: Install packages
  apt: name=iptables-persistent

- name: Install xtables-addons-dkms
  apt: name=xtables-addons-dkms
  when: ipp2p_drop

- name: Firewall open port format
  mf_readall:
  register: firewall

- name: Install firewall rules
  template: >
    src={{ item }}
    dest=/etc/iptables/
  with_items:
    - rules.v4
    - rules.v6
  notify:
    - reload iptables-v4
    - reload iptables-v6

- name: Add nf_conntrack_ipv4 to /etc/modules
  lineinfile: dest=/etc/modules regexp="nf_conntrack_ipv4" line=nf_conntrack_ipv4

- name: Copy sysctl file for conntrack
  copy: src=ipv4-netfilter-ip-conntrack-max.conf dest=/etc/sysctl.d/ipv4-netfilter-ip-conntrack-max.conf mode=0644 owner=root group=root
  notify: reload sysctl

- name: Add sysctl call to /etc/rc.local
  lineinfile: name=/etc/rc.local insertbefore="^exit" line="sysctl -p /etc/sysctl.d/ipv4-netfilter-ip-conntrack-max.conf"
