---
- name: Install packages
  apt: name={{ item }}
  with_items:
  - git
  - npm
  - ruby-sass

- name: Install grunt
  npm: name=grunt-cli global=yes

- name: Clone repository
  git: repo={{ meshviewer_git_root }}
       dest={{ meshviewer_path_src }}/
       force=yes

- name: Install node dependencies
  npm: path={{ meshviewer_path_src }}

- name: Build meshviewer
  command: nodejs /usr/local/bin/grunt
  args:
    chdir: {{ meshviewer_path_src }}

- name: Create destination directory
  file: path={{ meshviewer_path_bin }} state=directory

# does not work (https://github.com/ansible/ansible/issues/11873)
#- name: Copy generated files
#  delegate_to: "{{ inventory_hostname }}"
#  synchronize:
#    src: {{ meshviewer_path_src }}/build/
#    dest: {{ meshviewer_path_bin }}/
#    delete: True
#    rsync_opts:
#    - "--exclude=config.json"

- name: Copy files
  command: >
    rsync -a --delete --exclude config.json
    {{ meshviewer_path_src }}/build/
    {{ meshviewer_path_bin }}/

- name: Upload config
  template: src=config.json dest={{ meshviewer_path_bin }}/
