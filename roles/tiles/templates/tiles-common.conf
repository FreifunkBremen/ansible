# {{ ansible_managed }}

# VirtualHost configuration options common to both HTTP and HTTPS sites:

ServerName {{ tiles_subdomain }}.{{ main_domain }}
ServerAlias {{ tiles_subdomain }}.{{ alt_domain }}

# Enable HTTPS proxying
SSLProxyEngine On

# Don't add header to proxy
ProxyAddHeaders Off

# set this to customers mail address
ServerAdmin {{ tiles_email }}

Alias /.well-known/acme-challenge /var/www/{{ tiles_user }}/letsencrypt

CustomLog /readonly/{{ tiles_user }}/log/default-access.log combined env=!dontlog
ErrorLog /readonly/{{ tiles_user }}/log/default-error.log
ErrorLogFormat "[%{u}t] [%-m:%l] [pid %P:tid %T] %7F: %E: [client\ ANONYMIZED] %M% ,\ referer\ %{Referer}i"

RewriteEngine on
RewriteOptions inherit
RewriteRule ^/.well-known/acme-challenge - [L]
RewriteRule ^(.*)$ http://127.0.0.1:{{ tiles_tessera_port }}$1 [P,L]

# cache tiles for 7 days on disk, ignoring client refreshes
CacheEnable disk /
CacheDisable /.well-known/acme-challenge
CacheDefaultExpire 604800
CacheIgnoreCacheControl on
CacheIgnoreQueryString on
# this unifies the cache for HTTP and HTTPS
CacheKeyBaseURL "http://{{ tiles_domain }}/"
