# {{ ansible_managed }}

{% for host in backbone_peers %}
{% if batman_legacy is undefined or hostvars[host].batman_legacy is undefined or batman_legacy == hostvars[host].batman_legacy %}
{% set ifname = "backbone-vpn%d" % hostvars[host].vpn_id %}
# {{ host }}
auto {{ ifname }}
iface {{ ifname }} inet manual
  pre-up    ip link add $IFACE type gretap local {{ ansible_default_ipv4.address }} remote {{ host | resolve('a') }} ttl 64
  post-down ip link del $IFACE
  up   ip link set up   $IFACE
  down ip link set down $IFACE
  up   ip link set $IFACE mtu {{ [ hostvars[host].max_mtu, max_mtu ] | min }}
  up   batctl -m {{ batman_interface }} if add $IFACE
  down batctl -m {{ batman_interface }} if del $IFACE

{% endif %}
{% endfor %}
