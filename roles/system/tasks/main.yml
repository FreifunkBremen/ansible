---
- name: Installing sysctl.d configs
  copy:
    src: sysctl.d/
    dest: /etc/sysctl.d/
    mode: 0644
    owner: root
    group: root
  notify: reload sysctl

- name: Load modules needed for sysctl configs early
  lineinfile:
    dest: /etc/modules
    line: nf_conntrack
    regexp: '^nf_conntrack'

- name: Setting hostname
  hostname:
    name: "{{ hostname }}"
  when: hostname != 'defaulthost'

- name: Make boot non-quiet
  lineinfile:
    path: /etc/default/grub
    regexp: '^#?GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT=""'
  notify: update grub

- name: Configure VM
  include_tasks: vm.yml
  when: ansible_virtualization_role == "guest"

- name: Reboot host
  command: reboot
  when: reboot_flag
