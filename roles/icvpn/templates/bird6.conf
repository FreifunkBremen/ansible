# {{ ansible_managed }}
table ebgp;

define ownas = {{ icvpn_as }};

router id {{ batman_ipv4_address }};

### functions ###

# own network
function is_self_net() {
    return net ~ [
        fd2f:5119:f2c::/48+,
        2001:bf7:540::/44+,
        2001:bf7:550::/44+
    ];
};

function is_ula() {
    return net ~ [
        fc00::/7{48,64}
    ];
};

# freifunk ip ranges in general
function is_freifunk() {
    return is_ula() || (net ~ [
        2001:bf7::/32{44,64}
    ]);
};

function is_default() {
    return net ~ ::/0;
};

### kernel ###

protocol kernel k_main {
    scan time 10;
    import none;
    export where net != ::/0;
};

protocol kernel k_freifunk {
    table ebgp;
    kernel table 252;
    scan time 10;
    import none;
    export where net = ::/0;
};


# this pseudo-protocol watches all interface up/down events
protocol device {
    scan time 10;
};

protocol radv {
    interface "br-{{ site_code }}" {
        prefix fd2f:5119:f2c::/64 {};
        prefix 2001:bf7:540::/64 {};
        rdnss {
            ns {{ batman_ipv6_address }};
        };
        dnssl {
            domain "bremen.freifunk.net";
            lifetime mult 10;
        };
    };
    trigger ::/0; # disable sending when no default route is present
    export where net = ::/0;
};

### pipes ###

protocol pipe p_maintbl {
    peer table ebgp;
    import all;
    export none;
};

### static routes ###

# create a super route for own freifunk net in ebgp table
protocol static static_{{ site_code }} {
    table ebgp;
    route fd2f:5119:f2c::/48 reject;
    route 2001:bf7:540::/44 reject;
    route 2001:bf7:550::/44 reject;
};
# more specific routes in own freifunk net in master table
protocol static local_{{ site_code }} {
    route fd2f:5119:f2c::/64 via "br-{{ site_code }}";
    route 2001:bf7:540::/64 via "br-{{ site_code }}";
};

### icvpn peerings ###

template bgp icvpn {
    local as ownas;
    #source address fec0::a:cf:1:c4;
    direct;
    table ebgp;
    import where is_freifunk() && !is_self_net();
    export where is_freifunk();
};

template bgp icvpn_default from icvpn {
    import where (is_freifunk() || is_default()) && !is_self_net();
};

### internal peerings ###
protocol bgp vpn01 from icvpn {
    neighbor 2001:bf7:540::1 as ownas;
    import filter {
        bgp_path.prepend(ownas);
        if ((is_freifunk() || is_default()) && !is_self_net()) then accept;
        else reject;
    };
    direct;
};
protocol bgp vpn02 from icvpn {
    neighbor 2001:bf7:540::2 as ownas;
    import filter {
        bgp_path.prepend(ownas);
        if ((is_freifunk() || is_default()) && !is_self_net()) then accept;
        else reject;
    };
    direct;
};

protocol bgp vpn03 from icvpn {
    neighbor 2001:bf7:540::3 as ownas;
    import filter {
        bgp_path.prepend(ownas);
        if ((is_freifunk() || is_default()) && !is_self_net()) then accept;
        else reject;
    };
    direct;
};

### icvpn peerings ###
include "/etc/bird/bird6_icvpn.conf";
