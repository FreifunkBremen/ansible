---
- name: Install packages
  apt: name={{ item }}
  with_items:
    - tinc
    - sudo
    - python-yaml

#TODO Cronjob Daily pull
- name: Clone ICVPN repository
  git: repo={{ icvpn_git_root }}
       dest=/etc/tinc/icvpn/

#TODO not on vpn01 - why?
- name: Install POST-MERGE vor Tinc-Connection
  shell: cp /etc/tinc/icvpn/scripts/post-merge /etc/tinc/icvpn/.git/hooks/post-merge

- name: Install IC-VPN Tinc configuration
  template: >
    src=tinc.conf
    dest=/etc/tinc/icvpn/tinc.conf
    mode=0755

- name: Install IC-VPN Tinc up/down-Skript
  copy: >
    src={{item}}
    dest=/etc/tinc/icvpn/{{item}}
    mode=0755
  with_items:
    - tinc-down
    - tinc-up

- name: Add network configuration
  template: src=interfaces dest=/etc/network/interfaces.d/{{ icvpn_interface }}

- name: Check if a new private Key and hostfile is necessary
  stat: path=/etc/tinc/icvpn/rsa_key.priv
  register: hostsfile

- name: Generate Hostsfile for Github
  template: >
    src=pub-icvpn-gate
    dest=/etc/tinc/icvpn/hosts/{{ site_city }}{{ vpn_nr }}
    mode=0755
  when: hostsfile.stat.exists == False

- name: Generate Key
  shell: echo "" | tincd -n icvpn -K
  args:
    creates: /etc/tinc/icvpn/rsa_key.priv

- name: Install bird for Routing
  include: bird.yml

- name: Add ICVPN to Tinc start
  lineinfile: dest=/etc/tinc/nets.boot line="icvpn"

- name: Run first POST-MERGE to get Connections
  shell: cd /etc/tinc/icvpn/; ./.git/hooks/post-merge;

- name: Start tinc
  service: name=tinc state=restarted enabled=yes
