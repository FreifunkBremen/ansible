---
- name: Install packages
  apt: name={{ item }}
  with_items:
    - tinc
    - sudo
    - python-yaml

#TODO Cronjob Daily pull
- name: Clone ICVPN repository
  git: repo={{ icvpn_git_root }}
       dest=/etc/tinc/icvpn/

#TODO not on vpn01 - why?
#- name: Install POST-MERGE vor Tinc-Connection
#  copy: >
#    src=/etc/tinc/icvpn/scripts/post-merge
#    dest=/etc/tinc/icvpn/.git/hooks/post-merge
#    mode=0755

- name: Install IC-VPN Tinc up/down-Skript and Configuration
  template: >
    src={{item}}
    dest=/etc/tinc/icvpn/{{item}}
    mode=0755
  with_items:
    - tinc-down
    - tinc-up
    - tinc.conf

- name: Generate Key
  shell: echo "" | tincd -n icvpn -K
  args:
    creates: /etc/tinc/icvpn/rsa_key.priv

- name: Install bird for Routing
  include: bird.yml

- name: Add ICVPN to Tinc start
  lineinfile: dest=/etc/tinc/nets.boot line="icvpn"

- name: Start tinc
  service: name=tinc state=restarted enabled=yes

- name: Generate Hostsfile for Github
  template: >
    src=pub-icvpn-gate
    dest=/tmp/pub-icvpn-gate
    mode=0755

- name: Please Publish under https://github.com/freifunk/icvpn/hosts/{{ site_city }}{{ icvpn_nr }}
  shell: cat /etc/tinc/icvpn/rsa_key.pub >> /tmp/pub-icvpn-gate
  args:
    creates: /tmp/pub-icvpn-gate
