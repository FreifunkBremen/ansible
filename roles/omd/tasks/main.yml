---
- name : Get omd
  get_url: url='{{ omd_package }}' dest='/tmp/omd.deb'

- name: Install depences packages
  apt: name={{item}}  force=yes
  with_items:
  - php5
  - php5-sqlite
  - php5-mcrypt
  - php5-cgi
  - php5-gd
  - php-pear

- name: Install omd
  apt: deb=/tmp/omd.deb

#already exists
- name: Create site monitoring
  command: omd create monitoring

- name: Copy Run Scripts
  template: >
    src={{item}}
    dest=/tmp/{{item}}
    mode=0640
  with_items:
   - run-omdadmin-pw

- name: Create omdadmin User
  shell: cat /tmp/run-omdadmin-pw | su - monitoring -c "htpasswd ~/etc/htpasswd omdadmin"

- name: Start site monitoring
  command: omd start monitoring

- name: Cleanup Files
  file: path={{item}} state=absent
  with_items:
    - /tmp/omd.deb
    - /tmp/run-omdadmin-pw
