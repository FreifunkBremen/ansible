---
- name: Add user
  user: name={{ wiki_user }} home=/home/{{ wiki_user }} shell=/bin/zsh groups=webusers

- name: Create needed folder structure
  file: path={{ item }} state=directory recurse=yes owner={{ wiki_user }} group={{ wiki_group }} mode=0755
  with_items:
  - /home/{{ wiki_user }}/.opt/
  - /home/{{ wiki_user }}/.var/gollum-envs/
  - /var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/
  - /var/www/{{ wiki_user }}/cgi-bin/

- name: Clone gollum repository
  git: repo=https://github.com/gollum/gollum.git dest=/home/{{ wiki_user }}/.opt/gollum
  become: yes
  become_user: "{{ wiki_user }}"

- name: Install dependencies via bundler
  shell: bundle install --path .bundle chdir=/home/{{ wiki_user }}/.opt/gollum
  become: yes
  become_user: "{{ wiki_user }}"

- name: Clone wiki repository
  git: repo=https://github.com/FreifunkBremen/wiki.git dest=/home/{{ wiki_user }}/.var/gollum-envs/ff-bremen
  become: yes
  become_user: "{{ wiki_user }}"

- name: Create daemontools folder
  shell: /usr/local/bin/ffhb-setup-svscan creates=/home/{{ wiki_user }}/.config/service
  become: yes
  become_user: "{{ wiki_user }}"

- name: Create gollum daemontools folders
  file: path=/home/{{ wiki_user }}/.config/etc/{{ item }} recurse=yes owner={{ wiki_user }} group={{ wiki_group }} mode=0755
  with_items:
    - run-gollum
    - run-gollum/log

- name: Copy startscripts of gollum
  copy: src={{ item }} dest=/home/{{ wiki_user }}/.config/etc/run-gollum/{{ item }} owner={{ wiki_user }} group={{ wiki_user }} mode=0755
  with_items:
    - run
    - log/run

- name: Create symlink to start gollum
  file: src=/home/{{ wiki_user }}/.config/service/redis dest=/home/{{ wiki_user }}/.config/etc/run-redis state=link owner={{ wiki_user }} group={{ wiki_group }}

- name: Install .htaccess file
  copy: src=htaccess dest=/var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/.htaccess owner={{ wiki_user }} group={{ wiki_user }}

- name: Install robots.txt file
  copy: src=robots.txt dest=/var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/robots.txt owner={{ wiki_user }} group={{ wiki_user }}

- name: Install favicon.ico file
  copy: src=favicon.ico dest=/var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/favicon.ico owner={{ wiki_user }} group={{ wiki_user }}

- name: Install Apache site config
  template: src=ffhb-wiki.conf dest=/etc/apache2/sites-available/ mode=644

- name: Enable Apache site config
  command: a2ensite ffhb-wiki
  notify: restart apache
