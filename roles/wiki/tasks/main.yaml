---
- name: Add user
  user: name={{ wiki_user }} home=/home/{{ wiki_user }} shell=/bin/zsh groups=webusers

- name: Create needed folder structure
  file: path={{ item }} state=directory recurse=yes owner={{ wiki_user }} group={{ wiki_group }} mode=0755
  with_items:
  - /home/{{ wiki_user }}/.opt/
  - /home/{{ wiki_user }}/.var/gollum-envs/
  - /var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/

- name: Clone gollum repository
  git: repo=https://github.com/FreifunkBremen/gollum.git dest=/home/{{ wiki_user }}/.opt/gollum force=yes
  become: yes
  become_user: "{{ wiki_user }}"

- name: Install dependencies via apt
  apt: name={{ item }}
  with_items:
  - libicu-dev
  - zlib1g-dev
  - cmake
  - pkg-config

- name: Install dependencies via bundler
  shell: bundle install --path .bundle chdir=/home/{{ wiki_user }}/.opt/gollum
  become: yes
  become_user: "{{ wiki_user }}"

- name: Clone wiki repository
  git: repo=https://github.com/FreifunkBremen/wiki.git dest=/home/{{ wiki_user }}/.var/gollum-envs/ff-bremen force=yes
  become: yes
  become_user: "{{ wiki_user }}"

- name: Create daemontools folder
  shell: /usr/local/bin/ffhb-setup-svscan creates=/home/{{ wiki_user }}/.config/service
  become: yes
  become_user: "{{ wiki_user }}"

- name: Create gollum daemontools folders
  file: path=/home/{{ wiki_user }}/.config/etc/{{ item }} state=directory recurse=yes owner={{ wiki_user }} group={{ wiki_group }} mode=0755
  with_items:
    - run-gollum
    - run-gollum/log

- name: Copy start script of gollum
  template: src=run dest=/home/{{ wiki_user }}/.config/etc/run-gollum/run owner={{ wiki_user }} group={{ wiki_user }} mode=0755

- name: Copy log script of gollum
  copy: src=run-log dest=/home/{{ wiki_user }}/.config/etc/run-gollum/log/run owner={{ wiki_user }} group={{ wiki_user }} mode=0755

- name: Create symlink to start gollum
  file: src=/home/{{ wiki_user }}/.config/etc/run-gollum dest=/home/{{ wiki_user }}/.config/service/gollum state=link owner={{ wiki_user }} group={{ wiki_group }}

- name: Create .htpasswd file
  command: htpasswd -c -b /var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/.htpasswd wellenfunk foobar
  args:
    creates: /var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/.htpasswd

- name: Install .gitconfig file
  copy: src=gitconfig dest=/home/{{ wiki_user }}/.gitconfig owner={{ wiki_user }} group={{ wiki_user }}

- name: Install robots.txt file
  copy: src=robots.txt dest=/var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/robots.txt owner={{ wiki_user }} group={{ wiki_user }}

- name: Install favicon.ico file
  copy: src=favicon.ico dest=/var/www/{{ wiki_user }}/domains/{{ wiki_domain }}/favicon.ico owner={{ wiki_user }} group={{ wiki_user }}

# TODO: this should be replaced by some actually signed certificate:
- name: Generate self-signed SSL certificate
  command: openssl req -new -x509 -nodes -out /etc/ssl/certs/{{ wiki_domain }}.pem -keyout /etc/ssl/private/{{ wiki_domain }}.key -days 365 -subj "/CN={{ wiki_domain }}"
  args:
    creates: /etc/ssl/certs/{{ wiki_domain }}.pem

- name: Install Apache site config
  template: src=ffhb-wiki.conf dest=/etc/apache2/sites-available/ mode=644

- name: Enable Apache site config
  command: a2ensite ffhb-wiki
  notify: restart apache
